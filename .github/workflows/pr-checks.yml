name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quality-checks:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pytest pytest-mock
        pip install -e .
    
    - name: Run Pylint
      id: pylint
      run: |
        score=$(pylint src/ --exit-zero --score=y | grep -oP "Your code has been rated at \K[\d.]+")
        echo "score=$score" >> $GITHUB_OUTPUT
        echo "Pylint score: $score/10"
        pylint src/ --fail-under=9.5
    
    - name: Run Tests
      run: |
        pytest tests/ -v --tb=short
    
    - name: Comment PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const score = '${{ steps.pylint.outputs.score }}' || 'N/A';
          const passed = parseFloat(score) >= 9.5;
          
          const comment = `## 🔍 PR Quality Check
          
          **Pylint Score:** ${score}/10 ${passed ? '✅' : '❌'}
          **Tests:** Check workflow status above
          
          ${passed ? '✅ All checks passed!' : '❌ Pylint score must be 9.5 or higher'}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });